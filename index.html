<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <title>Programs and Courses | BTH</title>
    <style>
      * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        color: var(--strong);
        text-decoration: none;
        font-family: "Inter", sans-serif;
      }

      ul {
        list-style: none;
      }

      ul li {
        margin-bottom: 1rem;
      }

      :root {
        --background: #ffffff;
        --bottom: #f3f3f3;
        --middle: #eaeaea;
        --primary: #242424;
        --primary-light: #3d3d3d;
        --strong: #242424;
        --weak: #888888;

        --padding: 2rem;

        background-color: var(--background, #ffffff);
      }

      @media screen and (prefers-color-scheme: dark) {
        :root {
          --background: #242424;
          --bottom: #3d3d3d;
          --middle: #5c5c5c;
          --primary: #3378ff;
          --primary-light: #669aff;
          --strong: #ffffff;
          --weak: #bababa;

          background-color: var(--background, #242424);
        }
      }

      html {
        display: flex;
        align-items: center;
        flex-direction: column;
        width: 100vw;
        position: relative;
      }

      body {
        display: flex;
        flex-direction: column;
        width: calc(100vw - 2rem);
        max-width: 1024px;
        position: relative;
        padding: 1rem 0;
      }

      #backdrop {
        padding: var(--padding);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        background-color: var(--bottom);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
        overflow: hidden;
      }

      #backdrop > *:not(:last-child) {
        margin-bottom: 0.5rem;
      }

      #program-name {
        font-size: 2rem;
      }

      #program-points {
        font-size: 1.25rem;
        color: var(--weak);
      }

      #selectors {
        display: flex;
      }

      #selectors select {
        width: fit-content;
        background-color: var(--bottom);
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        margin-bottom: 1rem;
        height: 2.5rem;
        padding: 0 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #selectors > *:not(:last-child) {
        margin-right: 1rem;
      }

      #updated {
        font-size: 0.875rem;
        color: var(--weak);
        margin-top: 0.5rem;
      }

      #program-requirements {
        padding: 1rem;
        background-color: var(--bottom);
        margin-bottom: 1rem;
        border-radius: 0.5rem;
      }

      #program-requirements > *:first-child {
        margin-bottom: 0.25rem;
        font-size: 0.875rem;
        color: var(--weak);
      }

      a.current {
        background-color: var(--primary);
      }

      a.current * {
        color: #ffffff;
      }

      a.current .tag {
        background-color: var(--primary-light) !important;
        color: #ffffff;
      }

      .ellipsis {
        text-overflow: ellipsis;
        overflow: hidden;
        width: 100%;
      }

      .group-title {
        margin-bottom: 0.5rem;
        font-size: 1.125rem;
        font-weight: bold;
        width: 100%;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
      }

      .group-title > *:last-child {
        margin-left: 0.5rem;
        color: var(--weak);
        font-size: 0.875rem;
      }

      .course {
        background-color: var(--bottom);
        border-radius: 0.5rem;
        padding: 1rem;
        display: flex;
        flex-direction: column;
      }

      .course-metadata {
        display: flex;
        align-items: center;
        margin-top: 0.5rem;
      }

      .course-metadata > * {
        font-size: 0.875rem;
        color: var(--weak);
      }

      .course-splitter {
        margin: 0 0.5rem;
      }

      .course-requirements {
        margin-top: 0.5rem;
      }

      .course-name-container {
        display: flex;
        align-items: center;
        width: 100%;
        overflow: hidden;
      }

      .course-name-container > *:first-child {
        font-weight: bold;
      }

      .course-name-container > *:nth-child(2) {
        margin-left: 0.5rem;
        font-size: 0.75rem;
        background-color: var(--middle);
        color: var(--weak);
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
      }

      @media screen and (max-width: 768px) {
        :root {
          --padding: 1rem;
        }

        #program-name {
          font-size: 1.5rem;
        }

        #program-points {
          font-size: 1rem;
        }

        #program-selector {
          width: 100%;
        }

        #selectors {
          flex-direction: column;
        }

        #selectors select {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <a id="program-href" target="_blank">
      <div id="backdrop">
        <h1 id="program-name" class="ellipsis"></h1>
        <p id="program-points" class="ellipsis"></p>
      </div>
    </a>

    <div id="program-requirements" class=""></div>

    <div id="selectors">
      <select id="program-selector"></select>
      <select id="year-selector"></select>
    </div>

    <ul id="courses"></ul>

    <p style="color: var(--weak)">
      Skapad av
      <a
        href="https://marcusfredriksson.com"
        target="_blank"
        style="text-decoration: underline"
        >marcusfrdk</a
      >
    </p>

    <p id="updated">Data updated at</p>
  </body>
  <script type="text/javascript">
    const programSelector = document.getElementById("program-selector");
    const yearSelector = document.getElementById("year-selector");

    function getBlockingCourses(program) {
      // Currently a very poor implementation, since
      // the wording for "requirements" is very human-like,
      // meaning a computer implementation would be pretty
      // sketchy. Please improve this if you can.

      const courses = program.courses;
      const blockingCourses = [];
      const blockingWords = ["avklarad", "avklarade", "klarat av", "avklarat"];

      courses.forEach((course) => {
        blockingWords.forEach((word) => {
          const requirements = course.requirements.toLowerCase();
          if (requirements.includes(word)) {
            blockingCourses.push(course.name);
          }
        });
      });

      return blockingCourses;
    }

    function getPeriod(start) {
      // Periods are not exact and could differ and change,
      // theses values are just a rough estimate. Please
      // improve this if you can.
      const week =
        typeof start === "number" ? start : parseInt(start.split(" ")[2]);
      if (week < 10) return 3;
      if (week < 30) return 4;
      if (week < 44) return 1;
      if (week < 50) return 2;
    }

    function getCurrentWeek() {
      Date.prototype.getWeek = function () {
        // Week function taken from https://stackoverflow.com/a/14127528
        const date = new Date(this.getTime());
        date.setDate(date.getDate() + 4 - (date.getDay() || 7));
        const thursday = date.getTime();
        date.setMonth(0);
        date.setDate(1);
        const jan1st = date.getTime();
        const days = Math.round((thursday - jan1st) / 86400000);
        return Math.floor(days / 7) + 1;
      };
      return new Date().getWeek();
    }

    function highlightCurrentCourses(e) {
      const year = e
        ? parseInt(e.target.value)
        : parseInt(localStorage.getItem("year")) || 1;
      const period = getPeriod(getCurrentWeek());
      yearSelector.value = year;
      localStorage.setItem("year", year);

      const courses = document.getElementById("courses");

      courses.childNodes.forEach((node) => {
        if (node.nodeName === "LI") {
          if (node.childNodes[0].classList.contains(`y${year}p${period}`)) {
            node.childNodes[0].classList.add("current");
          } else {
            node.childNodes[0].classList.remove("current");
          }
        }
      });
    }

    function updateYearSelector(program) {
      const startYear = parseInt(program.start.split(" ")[0]);
      const endYear = parseInt(program.end.split(" ")[0]);
      const years = endYear - startYear;
      yearSelector.innerHTML = "";

      for (let i = 1; i <= years; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.label = `Läsår ${i}`;
        yearSelector.appendChild(option);
      }

      localStorage.setItem("year", 1);
      yearSelector.value = 1;

      highlightCurrentCourses();
    }

    function getGroupTitle(year, period) {
      const container = document.createElement("div");
      const yearTitle = document.createElement("p");
      const periodTitle = document.createElement("p");
      container.classList.add("group-title");
      yearTitle.innerText = `År ${year}`;
      periodTitle.innerText = `Läsperiod ${period}`;
      container.appendChild(yearTitle);
      container.appendChild(periodTitle);
      return container;
    }

    function setProgram(data) {
      document.getElementById("program-href").href = data.href;
      document.getElementById("program-name").innerText = data.name;
      document.getElementById("program-points").innerText = data.points + " hp";
      document.getElementById(
        "program-requirements"
      ).innerHTML = `<p>Krav</p><p class="ellipsis">${data.requirements}</p>`;

      const blockingCourses = getBlockingCourses(data);

      const courses = document.getElementById("courses");
      courses.innerHTML = "";

      period = 1;
      year = 1;

      if (getPeriod(data.courses[0].start) === 1) {
        courses.appendChild(getGroupTitle(year, period));
      }

      data.courses.forEach((course) => {
        prevPeriod = period;
        prevYear = year;
        period = getPeriod(course.start);
        if (period < prevPeriod) year++;

        if (prevPeriod !== period || prevYear !== year) {
          courses.appendChild(getGroupTitle(year, period));
        }

        const listItem = document.createElement("li");
        const anchor = document.createElement("a");
        anchor.target = "_blank";
        anchor.classList.add("course");
        anchor.classList.add(`y${year}p${period}`);
        const nameContainer = document.createElement("div");
        nameContainer.classList.add("course-name-container");
        nameContainer.classList.add("ellipsis");
        const name = document.createElement("p");
        const optional = document.createElement("p");
        optional.classList.add("tag");

        const metadata = document.createElement("div");
        metadata.classList.add("course-metadata");
        metadata.classList.add("ellipsis");

        const points = document.createElement("p");
        const code = document.createElement("p");
        const splitter = document.createElement("p");
        splitter.innerText = "|";
        splitter.classList.add("course-splitter");
        points.classList.add("course-points");
        code.classList.add("course-code");
        metadata.appendChild(code);
        metadata.appendChild(splitter);
        metadata.appendChild(points);

        if (blockingCourses.includes(course.name)) {
          const splitter2 = document.createElement("p");
          const blocking = document.createElement("p");
          splitter2.innerText = "|";
          splitter2.classList.add("course-splitter");
          blocking.innerText = "Kräver avklarade kurser";
          metadata.appendChild(splitter2);
          metadata.appendChild(blocking);
        }

        const requirements = document.createElement("p");
        requirements.classList.add("course-requirements");
        requirements.classList.add("ellipsis");
        requirements.innerText = course.requirements;

        anchor.href = course.href;

        name.innerText = course.name;
        nameContainer.appendChild(name);
        if (course.optional) {
          optional.innerText = "Valfri";
          nameContainer.appendChild(optional);
        }

        points.innerText = course.points + " hp";
        code.innerText = course.code;

        anchor.appendChild(nameContainer);
        anchor.appendChild(metadata);
        anchor.appendChild(requirements);
        listItem.appendChild(anchor);
        courses.appendChild(listItem);
      });

      highlightCurrentCourses();
    }

    async function getProgram(e) {
      const code = e.target.value;
      localStorage.setItem("program", code);
      const url = `https://api.github.com/repos/marcusfrdk/bth-programs/contents/data/${code}.json`;
      const response = await fetch(url);
      const data = await response.json();
      const content = JSON.parse(atob(data.content));
      setProgram(content);
      updateYearSelector(content);
      document.getElementById(
        "updated"
      ).innerText = `Datan genererades ${new Date(content.updated)}`;
    }

    async function getIndex() {
      const url =
        "https://api.github.com/repos/marcusfrdk/bth-programs/contents/data/index.json";
      const res = await fetch(url);
      const data = await res.json();
      const content = JSON.parse(atob(data.content)).sort();
      content.forEach((item) => {
        if (item !== "index") {
          const option = document.createElement("option");
          option.value = item;
          option.text = item.toUpperCase();
          programSelector.appendChild(option);
        }
      });
      const stored = localStorage.getItem("program");
      const value = stored || content[0];
      programSelector.value = value;
      getProgram({ target: { value } });
    }

    getIndex();
    programSelector.addEventListener("change", getProgram);
    yearSelector.addEventListener("change", highlightCurrentCourses);
    window.addEventListener("beforeunload", function () {
      programSelector.removeEventListener("change", getProgram);
    });
  </script>
</html>
